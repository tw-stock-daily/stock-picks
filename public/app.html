<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>台股精選</title>

  <style>
    :root{
      --bg:#0f1220;
      --card:#171a2f;
      --line:#262a4a;
      --text:#e9ecff;
      --muted:#9aa0ff;
      --pill:#2a2f66;
      --accent:#7aa2ff;
      --btn:#1f2350;
      --good:#39d98a;
      --warn:#ffd66b;
      --bad:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:14px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif;
      font-size:16px;       /* 手機不要小於 16px */
      line-height:1.55;     /* 行距放大 */
    }
    h1{ font-size:1.35rem; margin:0 0 8px; }
    .small{ font-size:0.9rem; color:var(--muted); }
    .muted{ color:var(--muted); }

    .wrap{ max-width:860px; margin:0 auto; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:var(--pill);
      font-size:0.85rem;
      white-space:nowrap;
    }
    .pill.good{ background:rgba(57,217,138,.18); color:var(--good); border:1px solid rgba(57,217,138,.35); }
    .pill.warn{ background:rgba(255,214,107,.18); color:var(--warn); border:1px solid rgba(255,214,107,.35); }
    .pill.bad{  background:rgba(255,107,107,.18); color:var(--bad);  border:1px solid rgba(255,107,107,.35); }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    select{
      width:100%;
      max-width:260px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      font-size:1rem;
      outline:none;
    }
    button{
      width:100%;
      max-width:260px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      font-size:1rem;
    }

    .pick{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }
    .pickName{
      font-size:1.05rem;
      font-weight:750;
      margin-bottom:4px;
    }
    .pickMeta{
      font-size:0.85rem;
      color:var(--muted);
    }

    details{ margin-top:10px; }
    summary{
      cursor:pointer;
      font-size:0.92rem;
      color:var(--accent);
      margin-bottom:6px;
    }

    .kv{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:8px 10px;
      font-size:0.92rem;
    }
    .kv div:nth-child(odd){ color:var(--muted); }

    .hr{ height:1px; background:var(--line); margin:10px 0; }

    #emptyHint{
      display:none;
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(154,160,255,.45);
      color:var(--muted);
    }

    /* 小手機再加強 */
    @media (max-width:420px){
      body{ font-size:17px; padding:12px; }
      .pickName{ font-size:1.12rem; }
      .kv{ grid-template-columns:100px 1fr; }
      select, button{ max-width:100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>台股精選</h1>
    <div class="small muted" id="updated">更新時間：—</div>

    <!-- 盤勢燈號 -->
    <div class="card">
      <div class="row">
        <div style="font-weight:750;">今日盤勢燈號</div>
        <div id="marketPill" class="pill">—</div>
      </div>
      <div class="small muted" id="marketMeta" style="margin-top:6px;">尚未更新</div>
      <div style="margin-top:8px;" id="marketMsg">等待 market.json 更新（早上 08:00 自動產生）。</div>
      <div class="small muted" id="marketNote" style="margin-top:8px;"></div>
    </div>

    <!-- 控制列 -->
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:750;">今日推薦</div>
          <div class="small muted" id="pickSub">—</div>
        </div>
        <div style="font-weight:850;" class="pill">TOP 3</div>
      </div>

      <div class="controls">
        <div>
          <div class="small muted" style="margin-bottom:6px;">價格區間</div>
          <select id="bucketSel">
            <option value="all">不限</option>
            <option value="lt100">100 以內</option>
            <option value="100_300">100 ~ 300</option>
            <option value="300_600">300 ~ 600</option>
            <option value="600_1000">600 ~ 1000</option>
            <option value="gt1000">1000 以上</option>
          </select>
        </div>

        <div>
          <div class="small muted" style="margin-bottom:6px;">操作</div>
          <button id="btnRefresh">重新整理</button>
        </div>

        <div>
          <div class="small muted" style="margin-bottom:6px;">來源</div>
          <button id="btnSource">查看 JSON</button>
        </div>
      </div>
    </div>

    <div id="emptyHint">目前沒有符合條件的推薦（或資料尚未更新）。</div>
    <div id="pickList"></div>
  </div>

  <script>
    const TODAY_URL = "./today.json";
    const MARKET_URL = "./market.json";

    function el(id){ return document.getElementById(id); }
    function fmt(n, d=2){
      if (n === null || n === undefined || Number.isNaN(Number(n))) return null;
      return Number(n).toFixed(d);
    }
    function fmtInt(n){
      if (n === null || n === undefined || Number.isNaN(Number(n))) return null;
      return String(Math.round(Number(n)));
    }
    function sign(n){
      const v = Number(n);
      if (!Number.isFinite(v)) return "";
      return v > 0 ? "+" : (v < 0 ? "-" : "");
    }

    function bucketOf(price){
      const p = Number(price);
      if (!Number.isFinite(p)) return "unknown";
      if (p < 100) return "lt100";
      if (p < 300) return "100_300";
      if (p < 600) return "300_600";
      if (p < 1000) return "600_1000";
      return "gt1000";
    }

    function inBucket(price, bucket){
      if (bucket === "all") return true;
      return bucketOf(price) === bucket;
    }

    async function loadMarket(){
      try{
        const r = await fetch(MARKET_URL, { cache:"no-store" });
        if (!r.ok) throw new Error("market.json not ready");
        const m = await r.json();

        // 盤勢燈號視覺
        const pill = el("marketPill");
        const sig = (m.signal || "").toLowerCase();
        pill.className = "pill";
        if (sig.includes("risk") || sig.includes("bad")) pill.classList.add("bad");
        else if (sig.includes("caution") || sig.includes("warn") || sig.includes("side")) pill.classList.add("warn");
        else if (sig.includes("on") || sig.includes("good") || sig.includes("bull")) pill.classList.add("good");

        pill.textContent = m.label || m.signal || "—";
        el("marketMeta").textContent = `更新：${m.asOfLocal || m.generatedAt || "未知"}`;
        el("marketMsg").textContent = m.message || "—";
        el("marketNote").textContent = m.note ? `備註：${m.note}` : "";
      }catch(e){
        el("marketPill").className = "pill";
        el("marketPill").textContent = "—";
        el("marketMeta").textContent = "尚未更新";
        el("marketMsg").textContent = "等待 market.json 更新（早上 08:00 自動產生）。";
        el("marketNote").textContent = "";
      }
    }

    let lastTodayData = null;

    function renderPicks(data){
      el("updated").textContent = "更新時間：" + (data.generatedAt || "未知");

      const bucketSel = el("bucketSel").value || "all";

      const picksAll = data.picks || [];
      const picks = picksAll.filter(p => inBucket(p.lastClose, bucketSel));

      el("pickSub").textContent = "共 " + (picks.length || 0) + " 檔（篩選後）";
      el("emptyHint").style.display = picks.length ? "none" : "block";

      const list = el("pickList");
      list.innerHTML = "";

      picks.forEach((p, i) => {
        const lastClose = fmt(p.lastClose, 2);
        const ma5 = fmt(p.ma5, 2);
        const ma20 = fmt(p.ma20, 2);
        const rsi14 = fmt(p.rsi14, 1);
        const volRatio = fmt(p.volRatio, 2);

        const plan = p.plan || null;
        const entryLow = plan ? fmt(plan.entryLow, 2) : null;
        const entryHigh = plan ? fmt(plan.entryHigh, 2) : null;
        const stop = plan ? fmt(plan.stop, 2) : null;
        const tp1 = plan ? fmt(plan.tp1, 2) : null;
        const tp2 = plan ? fmt(plan.tp2, 2) : null;

        const tradeStyle = p.tradeStyle || "—";

        const inst = p.inst || null;
        const sumTotal = inst ? fmtInt(inst.sumTotal) : null;
        const sumForeign = inst ? fmtInt(inst.sumForeign) : null;
        const sumTrust = inst ? fmtInt(inst.sumTrust) : null;
        const sumDealer = inst ? fmtInt(inst.sumDealer) : null;
        const buyStreak = inst ? inst.buyStreak : null;
        const latestTotalNet = inst ? fmtInt(inst.latestTotalNet) : null;
        const wDays = inst ? inst.windowDays : null;

        const div = document.createElement("div");
        div.className = "pick";
        div.innerHTML = `
          <div class="row">
            <div>
              <div class="pickName">#${i+1} ${p.symbol} ${p.name}</div>
              <div class="pickMeta">${p.reason || "—"} ｜ 操作：<span class="pill">${tradeStyle}</span></div>
            </div>
            <div style="font-weight:850;">${p.score !== undefined ? fmt(p.score, 4) : "-"}</div>
          </div>

          <details>
            <summary>看詳情（技術 / 交易計畫 / 法人）</summary>

            <div class="kv">
              <div>收盤價</div><div>${lastClose ?? "尚未提供"}</div>
              <div>MA5 / MA20</div><div>${(ma5 && ma20) ? (ma5 + " / " + ma20) : "尚未提供"}</div>
              <div>RSI14</div><div>${rsi14 ?? "尚未提供"}</div>
              <div>量比</div><div>${volRatio ?? "尚未提供"}</div>
            </div>

            <div class="hr"></div>

            <div class="kv">
              <div>進場區間</div><div>${(entryLow && entryHigh) ? (entryLow + " ~ " + entryHigh) : "尚未提供"}</div>
              <div>止損</div><div>${stop ?? "尚未提供"}</div>
              <div>TP1 / TP2</div><div>${(tp1 && tp2) ? (tp1 + " / " + tp2) : "尚未提供"}</div>
            </div>

            <div class="hr"></div>

            <div class="kv">
              <div>法人（T86）</div><div>${wDays ? `近 ${wDays} 日摘要` : "尚未提供"}</div>
              <div>合計淨買</div><div>${sumTotal ? `${sign(inst.sumTotal)}${sumTotal}` : "尚未提供"}</div>
              <div>外資/投信/自營</div><div>${(sumForeign && sumTrust && sumDealer) ? `${sign(inst.sumForeign)}${sumForeign} / ${sign(inst.sumTrust)}${sumTrust} / ${sign(inst.sumDealer)}${sumDealer}` : "尚未提供"}</div>
              <div>連買 / 最新一日</div><div>${(buyStreak != null && latestTotalNet) ? `${buyStreak} 日 / ${sign(inst.latestTotalNet)}${latestTotalNet}` : "尚未提供"}</div>
            </div>

          </details>
        `;
        list.appendChild(div);
      });
    }

    async function loadToday(){
      const r = await fetch(TODAY_URL, { cache:"no-store" });
      if (!r.ok) throw new Error("today.json 讀取失敗：" + r.status);
      const data = await r.json();
      lastTodayData = data;
      renderPicks(data);
    }

    async function loadAll(){
      await Promise.allSettled([loadMarket(), loadToday()]);
    }

    // 事件
    el("btnRefresh").onclick = () => loadAll().catch(e => alert(String(e?.message || e)));
    el("bucketSel").onchange = () => { if (lastTodayData) renderPicks(lastTodayData); };

    el("btnSource").onclick = () => {
      const base = location.href.replace(/\/[^\/]*$/, "/");
      alert("資料來源：\n" + base + "today.json\n" + base + "market.json");
    };

    loadAll().catch(e => {
      el("pickSub").textContent = "載入失敗";
      el("pickList").innerHTML = `<div class="small muted">${String(e?.message || e)}</div>`;
    });
  </script>
</body>
</html>
