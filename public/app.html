<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>台股精選</title>

  <style>
    :root{
      --bg:#0f1220;
      --card:#171a2f;
      --line:#262a4a;
      --text:#e9ecff;
      --muted:#9aa0ff;
      --pill:#2a2f66;
      --accent:#7aa2ff;
      --btn:#1f2350;
      --good:#39d98a;
      --warn:#ffd66b;
      --bad:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:14px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif;
      font-size:16px;
      line-height:1.55;
    }
    h1{ font-size:1.35rem; margin:0 0 8px; }
    .small{ font-size:0.9rem; color:var(--muted); }
    .muted{ color:var(--muted); }

    .wrap{ max-width:860px; margin:0 auto; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:var(--pill);
      font-size:0.85rem;
      white-space:nowrap;
    }
    .pill.good{ background:rgba(57,217,138,.18); color:var(--good); border:1px solid rgba(57,217,138,.35); }
    .pill.warn{ background:rgba(255,214,107,.18); color:var(--warn); border:1px solid rgba(255,214,107,.35); }
    .pill.bad{  background:rgba(255,107,107,.18); color:var(--bad);  border:1px solid rgba(255,107,107,.35); }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    select, button{
      width:100%;
      max-width:260px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      font-size:1rem;
    }

    .pick{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }
    .pickName{
      font-size:1.05rem;
      font-weight:750;
      margin-bottom:4px;
    }
    .pickMeta{
      font-size:0.85rem;
      color:var(--muted);
    }

    details{ margin-top:10px; }
    summary{
      cursor:pointer;
      font-size:0.92rem;
      color:var(--accent);
      margin-bottom:6px;
    }

    .kv{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:8px 10px;
      font-size:0.92rem;
    }
    .kv div:nth-child(odd){ color:var(--muted); }

    .hr{ height:1px; background:var(--line); margin:10px 0; }

    #emptyHint{
      display:none;
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(154,160,255,.45);
      color:var(--muted);
    }

    @media (max-width:420px){
      body{ font-size:17px; padding:12px; }
      .pickName{ font-size:1.12rem; }
      .kv{ grid-template-columns:100px 1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>台股精選</h1>
  <div class="small muted" id="updated">更新時間：—</div>

  <!-- 盤勢燈號 -->
  <div class="card">
    <div class="row">
      <div style="font-weight:750;">今日盤勢燈號</div>
      <div id="marketPill" class="pill">—</div>
    </div>
    <div class="small muted" id="marketMeta" style="margin-top:6px;">尚未更新</div>
    <div style="margin-top:8px;" id="marketMsg">—</div>
    <div class="small muted" id="marketNote" style="margin-top:8px;"></div>
  </div>

  <!-- 推薦 -->
  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:750;">今日推薦</div>
        <div class="small muted" id="pickSub">—</div>
      </div>
      <div class="pill">TOP 3</div>
    </div>

    <div class="controls">
      <select id="bucketSel">
        <option value="all">不限</option>
        <option value="lt100">100 以內</option>
        <option value="100_300">100 ~ 300</option>
        <option value="300_600">300 ~ 600</option>
        <option value="600_1000">600 ~ 1000</option>
        <option value="gt1000">1000 以上</option>
      </select>
      <button id="btnRefresh">重新整理</button>
      <button id="btnSource">查看 JSON</button>
    </div>
  </div>

  <div id="emptyHint">目前沒有符合條件的推薦。</div>
  <div id="pickList"></div>
</div>

<script>
const TODAY_URL = "./today.json";
const MARKET_URL = "./market.json";

function el(id){ return document.getElementById(id); }
function fmt(n,d=2){ return (n==null||isNaN(n))?null:Number(n).toFixed(d); }
function fmtInt(n){ return (n==null||isNaN(n))?null:String(Math.round(Number(n))); }
function sign(n){ return n>0?"+":(n<0?"-":""); }

function bucketOf(p){
  p=Number(p); if(!isFinite(p))return"unknown";
  if(p<100)return"lt100"; if(p<300)return"100_300";
  if(p<600)return"300_600"; if(p<1000)return"600_1000";
  return"gt1000";
}
function inBucket(p,b){ return b==="all"||bucketOf(p)===b; }

let lastToday=null;

async function loadMarket(){
  try{
    const r=await fetch(MARKET_URL,{cache:"no-store"});
    if(!r.ok)throw 0;
    const m=await r.json();
    const pill=el("marketPill");
    pill.className="pill";
    if(m.signal?.includes("risk"))pill.classList.add("bad");
    else if(m.signal?.includes("caution"))pill.classList.add("warn");
    else pill.classList.add("good");
    pill.textContent=m.label||m.signal||"—";
    el("marketMeta").textContent=`更新：${m.asOfLocal||m.generatedAt||"—"}`;
    el("marketMsg").textContent=m.message||"—";
    el("marketNote").textContent=m.note?`備註：${m.note}`:"";
  }catch{
    el("marketPill").textContent="—";
  }
}

function render(data){
  el("updated").textContent="更新時間："+(data.generatedAt||"—");
  const b=el("bucketSel").value;
  const picks=(data.picks||[]).filter(p=>inBucket(p.lastClose,b));
  el("pickSub").textContent=`共 ${picks.length} 檔`;
  el("emptyHint").style.display=picks.length?"none":"block";
  const list=el("pickList"); list.innerHTML="";
  picks.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="pick";
    div.innerHTML=`
      <div class="row">
        <div>
          <div class="pickName">#${i+1} ${p.symbol} ${p.name}</div>
          <div class="pickMeta">${p.reason||"—"} ｜ 操作：<span class="pill">${p.tradeStyle||"—"}</span></div>
        </div>
        <div style="text-align:right;">
          <div class="small muted">綜合評分</div>
          <div style="font-weight:850; font-size:1.05rem;">${fmt(p.score,4)||"-"}</div>
        </div>
      </div>
    `;
    list.appendChild(div);
  });
}

async function loadToday(){
  const r=await fetch(TODAY_URL,{cache:"no-store"});
  const d=await r.json();
  lastToday=d; render(d);
}

el("btnRefresh").onclick=()=>Promise.all([loadMarket(),loadToday()]);
el("bucketSel").onchange=()=>lastToday&&render(lastToday);
el("btnSource").onclick=()=>alert("資料來源：today.json / market.json");

loadMarket(); loadToday();
</script>
</body>
</html>
