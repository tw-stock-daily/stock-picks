<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>台股精選</title>

  <style>
    :root{
      --bg:#0f1220;
      --card:#171a2f;
      --line:#262a4a;
      --text:#e9ecff;
      --muted:#9aa0ff;
      --pill:#2a2f66;
      --accent:#7aa2ff;
      --btn:#1f2350;
      --good:#39d98a;
      --warn:#ffd66b;
      --bad:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:14px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif;
      font-size:16px;
      line-height:1.55;
    }
    h1{ font-size:1.35rem; margin:0 0 8px; }
    .small{ font-size:0.9rem; color:var(--muted); }
    .muted{ color:var(--muted); }

    .wrap{ max-width:860px; margin:0 auto; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:var(--pill);
      font-size:0.85rem;
      white-space:nowrap;
    }
    .pill.good{ background:rgba(57,217,138,.18); color:var(--good); border:1px solid rgba(57,217,138,.35); }
    .pill.warn{ background:rgba(255,214,107,.18); color:var(--warn); border:1px solid rgba(255,214,107,.35); }
    .pill.bad{  background:rgba(255,107,107,.18); color:var(--bad);  border:1px solid rgba(255,107,107,.35); }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    select, button{
      width:100%;
      max-width:260px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      font-size:1rem;
    }
    button{ cursor:pointer; }
    button:disabled{ opacity:.65; cursor:default; }

    .pick{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }

    /* ✅ 兩行標題：避免擁擠、避免分數跑出畫面 */
    .pickHeader{ display:flex; flex-direction:column; gap:6px; }

    .line1, .line2{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      min-width:0; /* 重要：避免 flex 子項溢出 */
    }

    .codeLine{
      font-size:1.05rem;
      font-weight:850;
      white-space:nowrap;
      flex:1;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .scoreLabel{
      font-size:0.9rem;
      font-weight:750;
      color:var(--muted);
      white-space:nowrap;
      flex-shrink:0;
    }

    .nameLine{
      font-size:1.02rem;
      font-weight:750;
      color:var(--text);
      flex:1;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap; /* ✅ 名稱不拆行，避免變兩行 */
    }

    .scoreValue{
      font-size:1.15rem;
      font-weight:900;
      white-space:nowrap;
      flex-shrink:0;
      margin-left:10px;
    }

    .pickMeta{
      font-size:0.85rem;
      color:var(--muted);
      margin-top:2px;
    }

    details{ margin-top:10px; }
    summary{
      cursor:pointer;
      font-size:0.92rem;
      color:var(--accent);
      margin-bottom:6px;
    }

    .kv{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:8px 10px;
      font-size:0.92rem;
    }
    .kv div:nth-child(odd){ color:var(--muted); }

    .hr{ height:1px; background:var(--line); margin:10px 0; }

    #emptyHint{
      display:none;
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(154,160,255,.45);
      color:var(--muted);
    }

    @media (max-width:420px){
      body{ font-size:17px; padding:12px; }
      .codeLine{ font-size:1.08rem; }
      .nameLine{ font-size:1.05rem; }
      .scoreValue{ font-size:1.18rem; }
      .kv{ grid-template-columns:100px 1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>台股精選</h1>
  <div class="small muted" id="updated">更新時間：—</div>

  <!-- 盤勢燈號 -->
  <div class="card">
    <div class="row">
      <div style="font-weight:750;">今日盤勢燈號</div>
      <div id="marketPill" class="pill">—</div>
    </div>
    <div class="small muted" id="marketMeta" style="margin-top:6px;">尚未更新</div>
    <div style="margin-top:8px;" id="marketMsg">—</div>
    <div class="small muted" id="marketNote" style="margin-top:8px;"></div>
  </div>

  <!-- 推薦 -->
  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:750;">今日推薦</div>
        <div class="small muted" id="pickSub">—</div>
      </div>
      <div class="pill">TOP 3</div>
    </div>

    <div class="controls">
      <select id="bucketSel">
        <option value="all">不限</option>
        <option value="lt100">100 以內</option>
        <option value="100_300">100 ~ 300</option>
        <option value="300_600">300 ~ 600</option>
        <option value="600_1000">600 ~ 1000</option>
        <option value="gt1000">1000 以上</option>
      </select>
      <button id="btnRefresh">重新整理</button>
      <button id="btnSource">查看 JSON</button>
    </div>
  </div>

  <div id="emptyHint">目前沒有符合條件的推薦。</div>
  <div id="pickList"></div>
</div>

<script>
const REMOTE_BASE = "https://tw-stock-daily.github.io/stock-picks/";
const BASE = (location.protocol === "file:")
  ? REMOTE_BASE
  : new URL("./", location.href).href;

const TODAY_URL  = BASE + "today.json";
const MARKET_URL = BASE + "market.json";

function el(id){ return document.getElementById(id); }
function fmt(n,d=2){ return (n==null||isNaN(n))?null:Number(n).toFixed(d); }
function fmtInt(n){ return (n==null||isNaN(n))?null:String(Math.round(Number(n))); }
function sign(n){ return n>0?"+":(n<0?"-":""); }

function bucketOf(p){
  p=Number(p); if(!isFinite(p))return"unknown";
  if(p<100)return"lt100"; if(p<300)return"100_300";
  if(p<600)return"300_600"; if(p<1000)return"600_1000";
  return"gt1000";
}
function inBucket(p,b){ return b==="all"||bucketOf(p)===b; }

let lastToday=null;

async function loadMarket(){
  try{
    const r=await fetch(MARKET_URL,{cache:"no-store"});
    if(!r.ok)throw new Error("market.json not ready");
    const m=await r.json();

    const pill=el("marketPill");
    pill.className="pill";
    if((m.signal||"").includes("risk")) pill.classList.add("bad");
    else if((m.signal||"").includes("caution")) pill.classList.add("warn");
    else pill.classList.add("good");

    pill.textContent=m.label||m.signal||"—";
    el("marketMeta").textContent=`更新：${m.asOfLocal||m.generatedAt||"—"}`;
    el("marketMsg").textContent=m.message||"—";
    el("marketNote").textContent=m.note?`備註：${m.note}`:"";
  }catch(e){
    el("marketPill").textContent="—";
    el("marketMeta").textContent="尚未更新";
    el("marketMsg").textContent="等待 market.json 更新（早上 08:00 自動產生）。";
    el("marketNote").textContent="";
  }
}

function render(data){
  el("updated").textContent="更新時間："+(data.generatedAt||"—");

  const b=el("bucketSel").value;
  const picks=(data.picks||[]).filter(p=>inBucket(p.lastClose,b));

  el("pickSub").textContent=`共 ${picks.length} 檔`;
  el("emptyHint").style.display=picks.length?"none":"block";

  const list=el("pickList");
  list.innerHTML="";

  picks.forEach((p,i)=>{
    const scoreText = (p.score !== undefined && p.score !== null) ? fmt(p.score,4) : "-";

    const div=document.createElement("div");
    div.className="pick";
    div.innerHTML=`
      <div class="pickHeader">
        <!-- ✅ 第一行：代號 +「綜合評分」文字 -->
        <div class="line1">
          <div class="codeLine">#${i+1} ${p.symbol}</div>
          <div class="scoreLabel">綜合評分</div>
        </div>

        <!-- ✅ 第二行：名稱 + 分數數字 -->
        <div class="line2">
          <div class="nameLine">${p.name || "—"}</div>
          <div class="scoreValue">${scoreText}</div>
        </div>

        <div class="pickMeta">${p.reason||"—"} ｜ 操作：<span class="pill">${p.tradeStyle||"—"}</span></div>
      </div>

      <details>
        <summary>看詳情（技術 / 交易計畫 / 法人）</summary>

        <div class="kv">
          <div>收盤價</div><div>${fmt(p.lastClose,2) ?? "尚未提供"}</div>
          <div>MA5 / MA20</div><div>${(fmt(p.ma5,2) && fmt(p.ma20,2)) ? (fmt(p.ma5,2) + " / " + fmt(p.ma20,2)) : "尚未提供"}</div>
          <div>RSI14</div><div>${fmt(p.rsi14,1) ?? "尚未提供"}</div>
          <div>量比</div><div>${fmt(p.volRatio,2) ?? "尚未提供"}</div>
        </div>

        <div class="hr"></div>

        <div class="kv">
          <div>進場區間</div><div>${(p.plan && fmt(p.plan.entryLow,2) && fmt(p.plan.entryHigh,2)) ? (fmt(p.plan.entryLow,2) + " ~ " + fmt(p.plan.entryHigh,2)) : "尚未提供"}</div>
          <div>止損</div><div>${(p.plan && fmt(p.plan.stop,2)) ? fmt(p.plan.stop,2) : "尚未提供"}</div>
          <div>TP1 / TP2</div><div>${(p.plan && fmt(p.plan.tp1,2) && fmt(p.plan.tp2,2)) ? (fmt(p.plan.tp1,2) + " / " + fmt(p.plan.tp2,2)) : "尚未提供"}</div>
        </div>

        <div class="hr"></div>

        <div class="kv">
          <div>法人（T86）</div><div>${p.inst?.windowDays ? `近 ${p.inst.windowDays} 日摘要` : "尚未提供"}</div>
          <div>合計淨買</div><div>${p.inst?.sumTotal != null ? `${sign(p.inst.sumTotal)}${fmtInt(p.inst.sumTotal)}` : "尚未提供"}</div>
          <div>外資 / 投信 / 自營</div><div>${(p.inst?.sumForeign!=null && p.inst?.sumTrust!=null && p.inst?.sumDealer!=null)
            ? `${sign(p.inst.sumForeign)}${fmtInt(p.inst.sumForeign)} / ${sign(p.inst.sumTrust)}${fmtInt(p.inst.sumTrust)} / ${sign(p.inst.sumDealer)}${fmtInt(p.inst.sumDealer)}`
            : "尚未提供"}</div>
          <div>連買 / 最新一日</div><div>${(p.inst?.buyStreak!=null && p.inst?.latestTotalNet!=null)
            ? `${p.inst.buyStreak} 日 / ${sign(p.inst.latestTotalNet)}${fmtInt(p.inst.latestTotalNet)}`
            : "尚未提供"}</div>
        </div>
      </details>
    `;
    list.appendChild(div);
  });
}

async function loadToday(){
  const r=await fetch(TODAY_URL,{cache:"no-store"});
  if(!r.ok) throw new Error("today.json 讀取失敗：" + r.status);
  const d=await r.json();
  lastToday=d;
  render(d);
}

async function loadAll(){
  await Promise.allSettled([loadMarket(), loadToday()]);
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = el("btnRefresh");
  const bucket = el("bucketSel");

  btn.addEventListener("click", async () => {
    const old = btn.textContent;
    try{
      btn.disabled = true;
      btn.textContent = "更新中…";
      await loadAll();
    }catch(e){
      alert(String(e?.message || e));
    }finally{
      btn.textContent = old;
      btn.disabled = false;
    }
  });

  bucket.addEventListener("change", () => {
    if(lastToday) render(lastToday);
  });

  el("btnSource").addEventListener("click", () => {
    alert("資料來源：\n" + TODAY_URL + "\n" + MARKET_URL);
  });

  loadAll().catch(()=>{});
});
</script>
</body>
</html>
