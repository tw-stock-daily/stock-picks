<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°è‚¡ç²¾é¸ï½œä»Šæ—¥æ¨è–¦</title>

  <style>
    :root{
      --bg:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --btn:#1e293b;
      --btn2:#24324f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --hot:#f59e0b;   /* æ©˜ï¼šåç†± */
      --cold:#60a5fa;  /* è—ï¼šåå†· */
      --good:#34d399;  /* ç¶ ï¼šåå¥½ */
      --bad:#fb7185;   /* ç´…ï¼šåé¢¨éšª */
      --warn:#fbbf24;  /* é»ƒï¼šæé†’ */
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial;
      background: linear-gradient(180deg, #060a12, var(--bg));
      color:var(--text);
    }

    .wrap{max-width: 980px; margin:0 auto; padding: 18px 14px 30px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;}
    .title{font-size: 20px; font-weight: 900;}
    .sub{color:var(--muted); font-size: 12px; margin-top:4px;}
    .actions{display:flex; gap:10px;}
    .btn{
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }

    .banner{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      margin-bottom: 14px;
      background: rgba(17,26,46,.55);
      box-shadow: var(--shadow);
    }
    .bannerTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .bannerTitle{font-weight: 900;}
    .bannerMeta{color:var(--muted); font-size:12px; margin-top:4px;}
    .bannerMsg{margin-top:10px; color: var(--text); line-height:1.55; font-size: 13px;}
    .bannerAction{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 13px;
      font-weight: 800;
    }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius:999px;
      background: rgba(17,26,46,.75);
      border:1px solid var(--line);
      font-size:12px;
      white-space:nowrap;
    }

    .grid{display:grid; grid-template-columns: 1fr; gap: 12px;}
    @media (min-width: 900px){
      .grid-2{grid-template-columns: 1.25fr .75fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px; border-bottom: 1px solid var(--line);}
    .card .bd{padding:14px;}
    .h{font-weight: 900;}
    .muted{color:var(--muted);}

    .list{display:flex; flex-direction:column; gap: 10px;}
    .pick{
      background: rgba(17,26,46,.55);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
    }
    .row{display:flex; justify-content:space-between; gap:12px; align-items:flex-start;}
    .pickName{font-size: 16px; font-weight: 900;}
    .pickMeta{color:var(--muted); font-size: 12px; margin-top:4px; line-height:1.35;}
    .pickHint{
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.16);
      font-size: 13px;
      line-height:1.45;
    }
    details{margin-top:10px;}
    details summary{cursor:pointer; color:var(--muted); font-weight:700;}
    .kv{display:grid; grid-template-columns: 130px 1fr; gap:8px 10px; margin-top:10px; font-size: 13px;}
    .kv div:nth-child(odd){color:var(--muted);}
    .hr{height:1px; background: var(--line); margin: 10px 0;}
    .small{font-size: 12px; color: var(--muted); line-height: 1.5;}
    code{background: rgba(0,0,0,.2); padding: 2px 6px; border-radius: 8px; border:1px solid var(--line);}

    /* === é¡è‰²æç¤º === */
    .hot { color: var(--hot); font-weight: 900; }
    .cold{ color: var(--cold); font-weight: 900; }
    .good{ color: var(--good); font-weight: 900; }
    .bad { color: var(--bad); font-weight: 900; }
    .warn{ color: var(--warn); font-weight: 900; }

    /* === åƒ¹æ ¼å€é–“ Filter === */
    .filterBar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .fbtn{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
    }
    .fbtn.active{
      background: rgba(37,99,235,.22);
      border-color: rgba(37,99,235,.65);
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <div class="title">å°è‚¡ç²¾é¸ï½œä»Šæ—¥æ¨è–¦</div>
      <div class="sub" id="updated">æ›´æ–°æ™‚é–“ï¼šè®€å–ä¸­â€¦</div>
    </div>
    <div class="actions">
      <button class="btn" id="btnRefresh">é‡æ–°æ•´ç†</button>
      <button class="btn" id="btnSource">è³‡æ–™ä¾†æº</button>
    </div>
  </div>

  <!-- ç›¤å‹¢ç‡ˆè™Ÿï¼ˆæ—©ä¸Š 08:00 æ›´æ–°ï¼‰ -->
  <div class="banner" id="marketBanner">
    <div class="bannerTop">
      <div>
        <div class="bannerTitle">ç›¤å‹¢ç‡ˆè™Ÿï¼ˆé–‹ç›¤å‰æç¤ºï¼‰</div>
        <div class="bannerMeta" id="marketMeta">å°šæœªæ›´æ–°</div>
      </div>
      <div class="pill" id="marketPill">â€”</div>
    </div>
    <div class="bannerMsg" id="marketMsg">ç­‰å¾… market.json æ›´æ–°ï¼ˆæ—©ä¸Š 08:00 è‡ªå‹•ç”¢ç”Ÿï¼‰ã€‚</div>
    <div class="bannerAction" id="marketAction">â€”</div>
    <div class="bannerMeta" id="marketNote"></div>
  </div>

  <div class="grid grid-2">

    <div class="card">
      <div class="hd">
        <div class="h">ä»Šæ—¥æ¨è–¦</div>
        <div class="sub" id="pickSub">è¼‰å…¥ä¸­â€¦</div>

        <!-- âœ… æ–°å¢ï¼šåƒ¹æ ¼å€é–“ -->
        <div class="filterBar" id="priceFilter">
          <button class="fbtn active" data-range="all">ä¸é™</button>
          <button class="fbtn" data-range="lt100">100 ä»¥å…§</button>
          <button class="fbtn" data-range="100_300">100~300</button>
          <button class="fbtn" data-range="300_600">300~600</button>
          <button class="fbtn" data-range="600_1000">600~1000</button>
          <button class="fbtn" data-range="gt1000">1000 ä»¥ä¸Š</button>
        </div>
      </div>

      <div class="bd">
        <div class="list" id="pickList"></div>
        <div class="small muted" id="emptyHint" style="display:none;">æ­¤åƒ¹æ ¼å€é–“ç›®å‰æ²’æœ‰æ¨è–¦è‚¡ç¥¨ï¼ˆå¯åˆ‡å›ã€Œä¸é™ã€æŸ¥çœ‹ï¼‰ã€‚</div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="h">ä½¿ç”¨æé†’</div>
      </div>
      <div class="bd">
        <div class="small">
          <b>æ¨è–¦å€‹è‚¡</b>ï¼ˆæ™šä¸Šè‡ªå‹•è¨ˆç®—ï¼‰èˆ‡ <b>ç›¤å‹¢ç‡ˆè™Ÿ</b>ï¼ˆæ—©ä¸Šé–‹ç›¤å‰æç¤ºï¼‰æ˜¯åˆ†é–‹çš„ï¼š<br/>
          - ç›¤å‹¢ç‡ˆè™Ÿåªåšé¢¨éšªæé†’ï¼Œä¸æ”¹æ¨è–¦åå–®ã€‚<br/>
          - è‹¥ç‡ˆè™Ÿåé¢¨éšªï¼Œå»ºè­°é™ä½éƒ¨ä½/åˆ†æ‰¹/åš´å®ˆåœæã€‚<br/>
          - åƒ¹æ ¼å€é–“æ˜¯ã€Œé¡¯ç¤ºéæ¿¾ã€ï¼Œä¸æœƒå½±éŸ¿ç­–ç•¥èˆ‡è‚¡ç¥¨æ± ã€‚<br/>
        </div>
        <div class="hr"></div>
        <div class="small">
          today.jsonï¼š<code>public/today.json</code><br/>
          market.jsonï¼š<code>public/market.json</code><br/>
          Appï¼ˆå…¥å£ï¼‰ï¼š<code>/app.html</code>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  const TODAY_URL = "./today.json";
  const MARKET_URL = "./market.json";

  function el(id){ return document.getElementById(id); }
  function fmt(n, d=2){
    if (n === null || n === undefined || Number.isNaN(Number(n))) return null;
    return Number(n).toFixed(d);
  }
  function fmtInt(n){
    if (n === null || n === undefined || Number.isNaN(Number(n))) return null;
    return String(Math.round(Number(n)));
  }
  function sign(n){
    const v = Number(n);
    if (!Number.isFinite(v)) return "";
    return v > 0 ? "+" : (v < 0 ? "-" : "");
  }

  // === ç›¤å‹¢â†’è¡Œå‹•æŒ‡å¼• ===
  function marketActionHint(signal){
    switch(String(signal || "").trim()){
      case "riskOn":
      case "bull":
        return { text: "ğŸ“ˆ åå¤šç›¤ï¼šå¯æ­£å¸¸æ“ä½œã€é †å‹¢ç‚ºä¸»ï¼ˆä»è«‹ç•™æ„çªç™¼æ¶ˆæ¯ï¼‰", cls: "good" };
      case "caution":
        return { text: "âš  éœ‡ç›ªç›¤ï¼šå»ºè­°å°éƒ¨ä½ã€åˆ†æ‰¹é€²å‡ºã€åš´å®ˆæ­¢æï¼ˆé¿å…è¿½é«˜ï¼‰", cls: "warn" };
      case "riskOff":
      case "bear":
        return { text: "ğŸ›‘ é¢¨éšªç›¤ï¼šä»¥è§€å¯Ÿç‚ºä¸»æˆ–æ¥µå°éƒ¨ä½ï¼Œå„ªå…ˆä¿æœ¬", cls: "bad" };
      default:
        return { text: "â€”", cls: "" };
    }
  }

  // === è‚¡ç¥¨â†’ç™½è©±æç¤º ===
  function tradeHint(style, plan, marketSignal){
    const s = String(style || "").trim();
    const ms = String(marketSignal || "").trim();

    const base = (s === "çŸ­æœŸ")
      ? "çŸ­ç·šæ“ä½œï¼šä»¥é‡èƒ½/éš”æ—¥å»¶çºŒç‚ºä¸»ï¼Œå»ºè­°åˆ†æ‰¹ï¼Œæ¼²å¤šä¸è¦è¿½ã€‚"
      : (s === "æ³¢æ®µ")
        ? "æ³¢æ®µæ“ä½œï¼šä»¥è¶¨å‹¢çºŒæŠ±ç‚ºä¸»ï¼Œè·Œç ´æ­¢æå³é€€å‡ºï¼Œé¿å…å‡¹å–®ã€‚"
        : "ä¾è¨ˆç•«åˆ†æ‰¹é€²å‡ºï¼Œåš´å®ˆæ­¢æã€‚";

    const riskAddon = (ms === "riskOff")
      ? "ï¼ˆä»Šæ—¥é¢¨éšªåé«˜ï¼šå»ºè­°æ›´å°éƒ¨ä½ï¼Œæˆ–ç­‰å¾…æ›´ä½³æ™‚æ©Ÿï¼‰"
      : (ms === "caution")
        ? "ï¼ˆä»Šæ—¥éœ‡ç›ªï¼šå¯åˆ†æ‰¹ã€ä¸è¦é‡æŠ¼ï¼‰"
        : "";

    if (!plan) return base + riskAddon;
    return base + " " + riskAddon;
  }

  // === æ•¸å­—â†’é¡è‰² class ===
  function rsiClass(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return "";
    if (n >= 70) return "hot";
    if (n <= 30) return "cold";
    return "";
  }
  function volRatioClass(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return "";
    if (n >= 2) return "good";
    if (n < 1) return "warn";
    return "";
  }
  function instClass(sumTotal){
    const n = Number(sumTotal);
    if (!Number.isFinite(n)) return "";
    if (n > 0) return "good";
    if (n < 0) return "bad";
    return "";
  }

  // === åƒ¹æ ¼å€é–“ ===
  const PRICE_RANGES = {
    all:      { label: "ä¸é™",    min: -Infinity, max: Infinity },
    lt100:    { label: "100 ä»¥å…§", min: -Infinity, max: 100 },
    "100_300":{ label: "100~300", min: 100, max: 300 },
    "300_600":{ label: "300~600", min: 300, max: 600 },
    "600_1000":{label:"600~1000", min: 600, max: 1000 },
    gt1000:   { label: "1000 ä»¥ä¸Š", min: 1000, max: Infinity },
  };

  function inPriceRange(price, key){
    const p = Number(price);
    if (!Number.isFinite(p)) return false;
    const r = PRICE_RANGES[key] || PRICE_RANGES.all;
    if (r.max === Infinity) return p >= r.min;
    if (r.min === -Infinity) return p < r.max;
    return p >= r.min && p < r.max;
  }

  let CURRENT_MARKET_SIGNAL = "";   // riskOn/caution/riskOff
  let CURRENT_PRICE_RANGE = "all";  // all/lt100/100_300/...
  let ALL_PICKS = [];               // today.json åŸå§‹ picks

  async function loadMarket(){
    try{
      const r = await fetch(MARKET_URL, { cache:"no-store" });
      if (!r.ok) throw new Error("market.json not ready");
      const m = await r.json();

      CURRENT_MARKET_SIGNAL = String(m.signal || "").trim();

      el("marketPill").textContent = m.label || m.signal || "â€”";
      el("marketMeta").textContent = `æ›´æ–°ï¼š${m.asOfLocal || m.generatedAt || "æœªçŸ¥"}`;
      el("marketMsg").textContent = m.message || "â€”";

      const act = marketActionHint(m.signal);
      el("marketAction").textContent = act.text;
      el("marketAction").className = "bannerAction " + (act.cls || "");

      el("marketNote").textContent = m.note ? `å‚™è¨»ï¼š${m.note}` : "";
    }catch(e){
      CURRENT_MARKET_SIGNAL = "";
      el("marketPill").textContent = "â€”";
      el("marketMeta").textContent = "å°šæœªæ›´æ–°";
      el("marketMsg").textContent = "ç­‰å¾… market.json æ›´æ–°ï¼ˆæ—©ä¸Š 08:00 è‡ªå‹•ç”¢ç”Ÿï¼‰ã€‚";
      el("marketAction").textContent = "â€”";
      el("marketAction").className = "bannerAction";
      el("marketNote").textContent = "";
    }
  }

  async function loadToday(){
    const r = await fetch(TODAY_URL, { cache:"no-store" });
    if (!r.ok) throw new Error("today.json è®€å–å¤±æ•—ï¼š" + r.status);
    const data = await r.json();

    el("updated").textContent = "æ›´æ–°æ™‚é–“ï¼š" + (data.generatedAt || "æœªçŸ¥");
    ALL_PICKS = Array.isArray(data.picks) ? data.picks : [];

    renderPicks();
  }

  function renderPicks(){
    const list = el("pickList");
    list.innerHTML = "";

    // ä¾åƒ¹æ ¼å€é–“éæ¿¾ï¼ˆé¡¯ç¤ºå±¤ï¼Œä¸å½±éŸ¿å¾Œç«¯ï¼‰
    const filtered = ALL_PICKS.filter(p => inPriceRange(p.lastClose, CURRENT_PRICE_RANGE));

    // æ–‡å­—é¡¯ç¤ºï¼šé¡¯ç¤ºå¹¾æª” / åŸå§‹ç¸½æ•¸
    el("pickSub").textContent = `é¡¯ç¤º ${filtered.length} / ${ALL_PICKS.length} æª”ï¼ˆåƒ¹æ ¼ï¼š${PRICE_RANGES[CURRENT_PRICE_RANGE]?.label || "ä¸é™"}ï¼‰`;
    el("emptyHint").style.display = filtered.length ? "none" : "block";

    filtered.forEach((p, i) => {
      const lastClose = fmt(p.lastClose, 2);
      const ma5 = fmt(p.ma5, 2);
      const ma20 = fmt(p.ma20, 2);
      const rsi14 = fmt(p.rsi14, 1);
      const volRatio = fmt(p.volRatio, 2);

      const plan = p.plan || null;
      const entryLow = plan ? fmt(plan.entryLow, 2) : null;
      const entryHigh = plan ? fmt(plan.entryHigh, 2) : null;
      const stop = plan ? fmt(plan.stop, 2) : null;
      const tp1 = plan ? fmt(plan.tp1, 2) : null;
      const tp2 = plan ? fmt(plan.tp2, 2) : null;

      const tradeStyle = p.tradeStyle || "â€”";

      const inst = p.inst || null;
      const sumTotal = inst ? fmtInt(inst.sumTotal) : null;
      const sumForeign = inst ? fmtInt(inst.sumForeign) : null;
      const sumTrust = inst ? fmtInt(inst.sumTrust) : null;
      const sumDealer = inst ? fmtInt(inst.sumDealer) : null;
      const buyStreak = inst ? inst.buyStreak : null;
      const latestTotalNet = inst ? fmtInt(inst.latestTotalNet) : null;
      const wDays = inst ? inst.windowDays : null;

      const rsiCls = rsi14 != null ? rsiClass(Number(rsi14)) : "";
      const volCls = volRatio != null ? volRatioClass(Number(volRatio)) : "";
      const instCls = inst && inst.sumTotal != null ? instClass(inst.sumTotal) : "";

      const hint = tradeHint(tradeStyle, plan, CURRENT_MARKET_SIGNAL);

      const div = document.createElement("div");
      div.className = "pick";
      div.innerHTML = `
        <div class="row">
          <div>
            <div class="pickName">#${i+1} ${p.symbol} ${p.name}</div>
            <div class="pickMeta">${p.reason || "â€”"} ï½œ æ“ä½œï¼š<span class="pill">${tradeStyle}</span> ï½œ æ”¶ç›¤ï¼š${lastClose ?? "â€”"}</div>
          </div>
          <div style="font-weight:900;">${p.score !== undefined ? fmt(p.score, 4) : "-"}</div>
        </div>

        <div class="pickHint">ğŸ‘‰ ${hint}</div>

        <details>
          <summary>çœ‹è©³æƒ…ï¼ˆæŠ€è¡“ / äº¤æ˜“è¨ˆç•« / æ³•äººï¼‰</summary>

          <div class="kv">
            <div>æ”¶ç›¤åƒ¹</div><div>${lastClose ?? "å°šæœªæä¾›"}</div>
            <div>MA5 / MA20</div><div>${(ma5 && ma20) ? (ma5 + " / " + ma20) : "å°šæœªæä¾›"}</div>
            <div>RSI14</div><div class="${rsiCls}">${rsi14 ?? "å°šæœªæä¾›"}</div>
            <div>é‡æ¯”</div><div class="${volCls}">${volRatio ?? "å°šæœªæä¾›"}</div>
          </div>

          <div class="hr"></div>

          <div class="kv">
            <div>é€²å ´å€é–“</div><div>${(entryLow && entryHigh) ? (entryLow + " ~ " + entryHigh) : "å°šæœªæä¾›"}</div>
            <div>æ­¢æ</div><div class="bad">${stop ?? "å°šæœªæä¾›"}</div>
            <div>TP1 / TP2</div><div class="good">${(tp1 && tp2) ? (tp1 + " / " + tp2) : "å°šæœªæä¾›"}</div>
          </div>

          <div class="hr"></div>

          <div class="kv">
            <div>æ³•äººï¼ˆT86ï¼‰</div><div>${wDays ? `è¿‘ ${wDays} æ—¥æ‘˜è¦` : "å°šæœªæä¾›"}</div>
            <div>åˆè¨ˆæ·¨è²·</div><div class="${instCls}">${sumTotal ? `${sign(inst.sumTotal)}${sumTotal}` : "å°šæœªæä¾›"}</div>
            <div>å¤–è³‡ / æŠ•ä¿¡ / è‡ªç‡Ÿ</div><div>${(sumForeign && sumTrust && sumDealer) ? `${sign(inst.sumForeign)}${sumForeign} / ${sign(inst.sumTrust)}${sumTrust} / ${sign(inst.sumDealer)}${sumDealer}` : "å°šæœªæä¾›"}</div>
            <div>é€£è²· / æœ€æ–°ä¸€æ—¥</div><div>${(buyStreak != null && latestTotalNet) ? `${buyStreak} æ—¥ / ${sign(inst.latestTotalNet)}${latestTotalNet}` : "å°šæœªæä¾›"}</div>
          </div>

          ${p.tech?.error ? `<div class="hr"></div><div class="small muted">æŠ€è¡“è³‡æ–™æŠ“å–å¤±æ•—ï¼š${p.tech.error}</div>` : ``}
          ${p.inst?.error ? `<div class="hr"></div><div class="small muted">æ³•äººè³‡æ–™æŠ“å–å¤±æ•—ï¼š${p.inst.error}</div>` : ``}
        </details>
      `;
      list.appendChild(div);
    });

    el("btnSource").onclick = () => {
      const base = location.href.replace(/\/[^\/]*$/, "/");
      alert("è³‡æ–™ä¾†æºï¼š\n" + base + "today.json\n" + base + "market.json");
    };
  }

  async function loadAll(){
    // å…ˆè¼‰ market å†è¼‰ todayï¼šè®“ç™½è©±æç¤ºå¯ä»¥åƒåˆ° CURRENT_MARKET_SIGNAL
    await loadMarket();
    await loadToday();
  }

  // åƒ¹æ ¼å€é–“æŒ‰éˆ•äº‹ä»¶
  el("priceFilter").onclick = (e) => {
    const key = e?.target?.dataset?.range;
    if (!key) return;
    CURRENT_PRICE_RANGE = key;

    // toggle active
    [...document.querySelectorAll("#priceFilter .fbtn")]
      .forEach(b => b.classList.toggle("active", b.dataset.range === key));

    // åªé‡æ–°æ¸²æŸ“ï¼Œä¸é‡æ–°æŠ“è³‡æ–™
    renderPicks();
  };

  el("btnRefresh").onclick = () => loadAll().catch(e => alert(String(e?.message || e)));

  loadAll().catch(e => {
    el("pickSub").textContent = "è¼‰å…¥å¤±æ•—";
    el("pickList").innerHTML = `<div class="small muted">${String(e?.message || e)}</div>`;
  });
</script>

</body>
</html>
